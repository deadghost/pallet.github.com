language: ruby
rvm:
  - 2.1.0
install:
  - sudo pip install Pygments
env:
  global:
    - secure: "LM5F5+TXWGVcqWVg7xDsaOZZNljN1gCTZPESGijeb3Ia1StFe+hHqx8fR7u5JBdHbJvowCEHGVdfRPHf2YZhpPpT4BKVVpu1hfyHZRZUPFewYWxr4NPSx5Rnr/9v1l6ZMOi324jQwPCSeE/gohqhFSj8Kk+nOEhvGIYBbTCGX8U="
    - "DDIR=tmp-deploy"
    - "TARGET_BRANCH=master"
    - "PROJECT=pallet/pallet.github.com"
before_script:
  - rm -rf $DDIR
script:
  - git clone https://github.com/$PROJECT.git --branch $TARGET_BRANCH --single-branch $DDIR
  - rm -rf _site blog _posts
  - bundle install
  - bundle exec jekyll doctor
  - bundle exec jekyll build --verbose --trace --destination $DDIR
  - ls -lR $DDIR
after_success:
  - cd $DDIR
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://tbatchelli:${GH_PASSWD}@github.com" > .git/credentials
#  - git remote set-url origin https://github.com/${PROJECT}.git
  - ls -lR .git
  - git add -A .
  - git config user.email "tbatchelli@acm.org"
  - git config user.name "tbatchelli"
  - git commit -am "new-site-deployed" --allow-empty
  - git push origin $TARGET_BRANCH 2>&1
after_script:
  - rm -rf $DDIR
notifications:
  irc: irc.freenode.org#pallet

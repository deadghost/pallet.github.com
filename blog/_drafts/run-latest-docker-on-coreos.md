---
layout: main/blog-post
title: Run the latest docker on CoreOS
author: Hugo Duncan
section: blog
categories:
    - docker
    - coreos
---

[CoreOS][coreos] is a read-only linux distribution for running
clusters of containers.  We wanted to run the latest docker to test
the upcoming `docker start` command in [docker][docker] 1.3.0, and
this is how we did it using [fleet][fleet], a distributed `systemd`.
This approach could equally well be used with any of CoreOS's built in
services.

## Building the latest docker

To build the latest docker, we are going to use docker itself to build
the updated docker binary in a container.  To do this on all the
machines in a cluster, we use a fleet unit, `latest-docker.service`
which is a [systemd][systemd] unit with a small extension:

Our unit is going to use docker, so we make sure docker is running
before our service:

```
[Unit]
Wants=docker.service
After=docker.service
```

The `Service` section describes the processes we want run.  The
`oneshot` type says that we want this process to run, but it isn't
expected to stay up as a daemon would:

```
[Service]
Type=oneshot
```

Now we get to actually building [docker][docker].  To do this we are
going to use the `cocker-dev` image which is based on a Dockerfile in
the docker github repository.  The image is on the
[docker hub][docker-dev], so we don't have to build it ourselves, just
run it.

Continuing the service file, we are going to run the image, update the
git checkout of docker to the latest `$BRANCH` from github, optionally
checkout a different commit or tag (using `$COMMITISH`), and then
build docker.

```
Environment="COMMITISH=e7a9662974ad12e1926599e64dca44aaf1a90145"
Environment="BRANCH=master"

ExecStart=/bin/bash -c '[ -x /var/bin/docker ] || \
docker run --privileged --rm \
   -v /tmp/docker-bundles:/go/src/github.com/docker/docker/bundles \
   docker-dev:latest \
   bash -c "git checkout ${BRANCH} && \
            git pull && \
            git checkout ${COMMITISH} && \
            hack/make.sh binary"'
```

This is going to give us a binary in
/tmp/docker-bundles/1.2.0-dev/binary/docker-1.2.0-dev.

We can't just replace the docker binary, since it is in the read-only
CoreOS `/usr` filesystem, but we can create a systemd "drop-in"
configuration to change the `ExecStart` command for docker.  We do
this with a sequence of `ExecStart` commands.  The only subtle point
here is the `ExecStart=` line in the configuration file, without a
value, which is used to remove the previous value of `ExecStart` for
the docker service.

```
ExecStart=/usr/bin/mkdir -p /var/bin
ExecStart=/usr/bin/cp /tmp/docker-bundles/1.2.0-dev/binary/docker-1.2.0-dev /var/bin/docker
ExecStart=/usr/bin/mkdir -p /run/systemd/system/docker.service.d
ExecStart=/bin/bash -c 'echo "[Service]\nExecStart=\nExecStart=/var/bin/docker --daemon --storage-driver=btrfs --host=fd://" > /run/systemd/system/docker.service.d/10-start.conf'
ExecStart=/usr/bin/echo "Docker set to run from /var/bin/docker"
```

To actually restart the docker service, we call systemd.  This is run in a separate process so the commands don't kill the `latest-docker` service.

```
ExecStart=/bin/bash -c 'nohup bash -c "/usr/bin/systemctl daemon-reload; /usr/bin/systemctl restart docker.service;" & sleep 1;'
```

The `Install` section of the file is going to get the unit run:

```
[Install]
WantedBy=multi-user.target
```

We want the unit to be run on all nodes in the cluster, so we use the
`X-Fleet` section to specify this.

```
[X-Fleet]
Global=true
```



# Switching Back to the Default CoreOS docker Version

To get back to the default docker service, we create a
`core-docker.service` which deletes the "drop-in" configuration
generated by `latest-docker.service`.


The full source for the units is in [this gist](https://gist.github.com/hugoduncan/48fd844072060b883671).

{% gist 48fd844072060b883671 %}






[coreos]:https://coreos.com/ "CoreOS"
[docker]:https://docker.com/ "docker"
[docker-dev]:https://registry.hub.docker.com/_/docker-dev/ "docker-dev on docker hub"
[fleet]:https://coreos.com/docs/#launching-containers "fleet"
[systemd]:http://www.freedesktop.org/wiki/Software/systemd/ "systemd"

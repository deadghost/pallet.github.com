language: ruby
rvm:
  - 2.1.0
install:
  - sudo pip install Pygments
env:
  global:
    - secure: "Dv1PuducE+CBuBEDFTqHCNfMRkjQsHI1sDXBAn6wOH5XuFQBLqXK4+3foF1n3w3neic9W30odIc+oOJlI+xRG9wFbhCOUZFrPLBDk753QK+jKYmhd/TF4yNPSi2c4Ik4UIgDWqQ1a/kh5KhozOPeju6SZDGHTBv2oXJl9mXoHyA="
    - "DDIR=tmp-deploy"
    - "TARGET_BRANCH=master"
    - "PROJECT=pallet/pallet.github.com"
before_script:
  - rm -rf $DDIR
script:
  - git clone https://github.com/$PROJECT.git --branch $TARGET_BRANCH --single-branch $DDIR
  - rm -rf $DDIR
  - bundle install
  - bundle exec jekyll doctor
  - bundle exec jekyll build --verbose --trace --destination $DDIR
  - ls -lR $DDIR
after_success:
  - cd $DDIR
  - git config credential.helper "store --file=.git/credentials"
  - echo "https://tbatchelli:${GH_PASSWD}@github.com" > .git/credentials
  - git remote set-url origin https://github.com/pallet/pallet.github.com.git
  - git add -A .
  - git config user.email "tbatchelli@acm.org"
  - git config user.name "tbatchelli"
  - git commit -am "new-site-deployed" --allow-empty
  - git push origin $TARGET_BRANCH 2>&1
after_script:
  - rm -rf $DDIR
notifications:
  irc: irc.freenode.org#pallet
